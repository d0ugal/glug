name: CI

on:
    push:
        branches: [main, master]
    pull_request:

env:
    GO_VERSION: "1.21"

jobs:
    test:
        name: Test
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Install dependencies
              run: go mod download

            - name: Run tests
              run: go test -v -race -coverprofile=coverage.txt -covermode=atomic ./...

            - name: Upload coverage to Codecov
              uses: codecov/codecov-action@v5
              with:
                  file: ./coverage.txt
                  flags: unittests
                  name: codecov-umbrella

    lint:
        name: Lint
        runs-on: ubuntu-latest

        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Run golangci-lint
              uses: golangci/golangci-lint-action@v9
              with:
                  version: latest

    build:
        name: Build
        runs-on: ubuntu-latest
        needs: [test]

        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Set up Go
              uses: actions/setup-go@v6
              with:
                  go-version: ${{ env.GO_VERSION }}

            - name: Build
              run: |
                  VERSION=$(git describe --tags --always --dirty 2>/dev/null || echo "dev")
                  COMMIT=$(git rev-parse --short HEAD 2>/dev/null || echo "unknown")
                  BUILD_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")

                  go build -v -ldflags="-s -w \
                    -X github.com/dougalmatthews/glug/internal/version.Version=$VERSION \
                    -X github.com/dougalmatthews/glug/internal/version.Commit=$COMMIT \
                    -X github.com/dougalmatthews/glug/internal/version.BuildDate=$BUILD_DATE" \
                    -o glug .

            - name: Upload build artifacts
              uses: actions/upload-artifact@bbbca2ddaa5d8feaa63e36b76fdaad77386f024f # v7
              with:
                  name: glug
                  path: glug
                  retention-days: 30

    security:
        name: Security Scan
        runs-on: ubuntu-latest
        permissions:
            contents: read
            security-events: write

        steps:
            - name: Checkout code
              uses: actions/checkout@v6
              with:
                  fetch-depth: 0

            - name: Run Trivy vulnerability scanner
              uses: aquasecurity/trivy-action@master
              with:
                  scan-type: "fs"
                  scan-ref: "."
                  format: "table"
                  exit-code: "1"
                  severity: "CRITICAL,HIGH"
